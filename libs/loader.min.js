"use strict";function loader(){this._init()}loader.prototype._init=function(){};loader.prototype._setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};loader.prototype._setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerText=a};loader.prototype._load=function(a){this._loadIcons();this._loadAnimates();this._loadMusic();core.loader._loadMaterialImages(function(){core.loader._loadExtraImages(function(){core.loader._loadAutotiles(function(){core.loader._loadTilesets(a)})})})};loader.prototype._loadIcons=function(){this.loadImage("icons.png",function(a,b){var c=core.splitImage(b);for(var d in core.statusBar.icons){if(typeof core.statusBar.icons[d]=="number"){core.statusBar.icons[d]=c[core.statusBar.icons[d]];if(core.statusBar.image[d]!=null){core.statusBar.image[d].src=core.statusBar.icons[d].src}}}})};loader.prototype._loadMaterialImages=function(a){this.loadImages(core.materials,core.material.images,a)};loader.prototype._loadExtraImages=function(a){core.material.images.images={};var b=core.clone(core.images);if(b.indexOf("hero.png")<0){b.push("hero.png")}this.loadImages(b,core.material.images.images,a)};loader.prototype._loadAutotiles=function(b){core.material.images.autotile={};var c=Object.keys(core.material.icons.autotile);var a={};this.loadImages(c,a,function(){c.forEach(function(d){core.material.images.autotile[d]=a[d]});setTimeout(function(){core.maps._makeAutotileEdges()});b()})};loader.prototype._loadTilesets=function(a){core.material.images.tilesets={};core.tilesets=core.tilesets||[];core.loader.loadImages(core.clone(core.tilesets),core.material.images.tilesets,function(){for(var c in core.material.images.tilesets){var b=core.material.images.tilesets[c];if(b.width%32!=0||b.height%32!=0){console.warn("警告！"+c+"的宽或高不是32的倍数！")}if(b.width*b.height>32*32*3000){console.warn("警告！"+c+"上的图块素材个数大于3000！")}}a()})};loader.prototype.loadImages=function(d,e,a){if(!d||d.length==0){if(a){a()}return}var c=0;for(var b=0;b<d.length;b++){this.loadImage(d[b],function(f,g){core.loader._setStartLoadTipText("正在加载图片 "+f+"...");if(e[f]!==undefined){if(g!=null){e[f]=g}return}e[f]=g;c++;core.loader._setStartProgressVal(c*(100/d.length));if(c==d.length){if(a){a()}}})}};loader.prototype.loadImage=function(d,a){try{var f=d;if(f.indexOf(".")<0){f=f+".png"}var c=new Image();c.onload=function(){a(d,c)};c.onerror=function(){a(d,null)};c.src="project/images/"+f+"?v="+main.version;if(f.endsWith(".gif")){a(d,null)}}catch(b){main.log(b)}};loader.prototype._loadAnimates=function(){core.animates.forEach(function(a){core.http("GET","project/animates/"+a+".animate",null,function(b){try{b=JSON.parse(b);var c={};c.ratio=b.ratio;c.se=b.se;c.images=[];c.images_rev=[];b.bitmaps.forEach(function(h){if(!h){c.images.push(null)}else{try{var g=new Image();g.src=h;c.images.push(g)}catch(f){main.log(f);c.images.push(null)}}});c.frame=b.frame_max;c.frames=[];b.frames.forEach(function(f){var e=[];f.forEach(function(g){e.push({index:g[0],x:g[1],y:g[2],zoom:g[3],opacity:g[4],mirror:g[5]||0,angle:g[6]||0,})});c.frames.push(e)});core.material.animates[a]=c}catch(d){main.log(d);core.material.animates[a]=null}},function(b){main.log(b);core.material.animates[a]=null},"text/plain; charset=x-user-defined")})};loader.prototype._loadMusic=function(){core.bgms.forEach(function(a){core.loader.loadOneMusic(a)});core.sounds.forEach(function(a){core.loader.loadOneSound(a)});core.playBgm(main.startBgm)};loader.prototype.loadOneMusic=function(b){var a=new Audio();a.preload="none";if(main.bgmRemote){a.src=main.bgmRemoteRoot+core.firstData.name+"/"+b}else{a.src="project/sounds/"+b}a.loop="loop";core.material.bgms[b]=a};loader.prototype.loadOneSound=function(b){if(core.musicStatus.audioContext!=null){core.http("GET","project/sounds/"+b,null,function(c){try{core.musicStatus.audioContext.decodeAudioData(c,function(e){core.material.sounds[b]=e},function(f){main.log(f);core.material.sounds[b]=null})}catch(d){main.log(d);core.material.sounds[b]=null}},function(c){main.log(c);core.material.sounds[b]=null},null,"arraybuffer")}else{var a=new Audio();a.src="project/sounds/"+b;core.material.sounds[b]=a}};loader.prototype.loadBgm=function(b){b=core.getMappedName(b);if(!core.material.bgms[b]){return}if(!core.musicStatus.bgmStatus){return}var a=core.musicStatus.cachedBgms.indexOf(b);if(a>=0){core.musicStatus.cachedBgms.splice(a,1)}else{this._preloadBgm(core.material.bgms[b]);if(core.musicStatus.cachedBgms.length==core.musicStatus.cachedBgmCount){this.freeBgm(core.musicStatus.cachedBgms.pop())}}core.musicStatus.cachedBgms.unshift(b)};loader.prototype._preloadBgm=function(a){a.volume=0;a.play()};loader.prototype.freeBgm=function(a){a=core.getMappedName(a);if(!core.material.bgms[a]){return}core.musicStatus.cachedBgms=core.musicStatus.cachedBgms.filter(function(b){return b!=a});core.material.bgms[a].removeAttribute("src");core.material.bgms[a].load();core.material.bgms[a]=null;if(a==core.musicStatus.playingBgm){core.musicStatus.playingBgm=null}setTimeout(function(){core.loader.loadOneMusic(a)},3000)};